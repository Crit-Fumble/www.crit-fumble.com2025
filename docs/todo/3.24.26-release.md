# March 24, 2026 Test Release

**Target Date:** March 24, 2026 (3 months)

**Goal:** Working D&D 5e VTT where players can create characters, join sessions, move tokens on a battle map, and roll dice in combat.

**Access Model:**
- **Admins:** Full access to all features (Creator + GM + Player)
- **GMs:** Access to GM and Player features only
- **Players:** Access to Player features only

**Philosophy:** Creator-first approach. Admins establish the world hierarchy and scaling foundation before GMs create campaigns and players join sessions.

---

## Phase 0: Role Management System (COMPLETED ✓)

**Purpose:** Establish role-based permissions for Admin/GM/Player access control.

**Completed Features:**
- [x] Database schema with `roles` JSON field (supports multiple roles per user)
- [x] Database schema with `viewAsRole` field (owner testing feature)
- [x] Role hierarchy system (Player → GameMaster → Storyteller → Worldbuilder → Creator → Moderator → Admin)
- [x] Permission checking functions (hasRole, hasAnyRole, hasAllRoles, hasRoleLevel)
- [x] Owner override (owners have all roles by default)
- [x] Role management utilities (grantRole, revokeRole, setRoles)
- [x] "View As" feature for owners to test different role perspectives
- [x] Server actions for role switching (setViewAsRole, clearViewAsRole)
- [x] Session integration (viewAsRole persists in auth session)
- [x] Role management page at /owners/roles (owner-only)
- [x] UserMenu dropdown with "View As" role selector
- [x] Role badges with color-coding in UI
- [x] TypeScript types for all role functionality

**Role Definitions:**
- **Player (Level 0):** Can join and play in campaigns
- **GameMaster (Level 1):** Can run campaigns and manage game sessions
- **Storyteller (Level 2):** Can create and edit world histories and lore
- **Worldbuilder (Level 3):** Can create and manage worlds and universes
- **Creator (Level 4):** Can create and publish tiles, assets, and collections
- **Moderator (Level 5):** Can moderate content and manage community
- **Admin (Level 6):** Can access admin panel and manage platform settings

**Files:**
- `src/lib/permissions.ts` - Core role system
- `src/app/actions/roles.ts` - Server actions
- `src/app/owners/roles/page.tsx` - Role management UI
- `src/components/molecules/UserMenu.tsx` - "View As" dropdown
- `src/types/next-auth.d.ts` - Session type extension
- `prisma/schema.prisma` - Database schema with roles/viewAsRole

---

## Phase 1: Creator/Admin Foundation (Week 1-2)

**Purpose:** Establish the world hierarchy and scaling system that everything else depends on.

### World Scale System (Hard-coded Constants)
- [ ] Define all world scales in code (per VTTImageScaleGuidelines.md)
- [ ] Create scale constants file/module (`src/lib/constants/vtt-scales.ts`)
- [ ] Hard-code pixel dimensions per scale
- [ ] Hard-code pixel-to-real-world ratios
- [ ] Document zoom levels for multi-resolution support
- [ ] Implement dynamic tile loading based on zoom

**March 2026 Scope - Square/Hex Scales Only:**

**1. Arena Scale** (Combat encounters, tokens)
- Type: Square grid
- Tile: 5ft squares
- Digital: 60 x 60 x 3 pixels per tile (1 pixel = 1 inch - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per 5ft tile (1" = 5ft miniature scale)
- Physical tile size: 1" x 1" @ 300 DPI (standard 1" = 5ft scale for minis)
- Use case: Battle maps, combat encounters, miniature play

**2. Exploration - Building Scale** (Dungeons, buildings)
- Type: Square grid
- Tile: 10ft squares
- Digital: 30 x 30 x 3 pixels per tile (1 pixel = 4 inches - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per 10ft tile (1" = 10ft miniature scale)
- Physical tile size: 1" x 1" @ 300 DPI (standard 1" = 10ft scale)
- Use case: Adventure locations, dungeon crawls, building interiors

**3. Exploration - Settlement Scale** (Towns, wilderness)
- Type: Hex grid
- Tile: 30ft hexes
- Digital: 34 x 30 x 5 pixels per hex (1 pixel = 1ft - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per hex (1" flat-to-flat at 1" = 30ft scale)
- Physical hex size: 1" flat-to-flat @ 300 DPI (1" = 30ft scale)
- Use case: Town maps, small wilderness areas, settlement exploration

**4. Travel - County Scale** (Regional travel)
- Type: Hex grid
- Tile: 0.1 mile hex (528ft)
- Digital: 610 x 528 pixels per hex (1 pixel = 1ft - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per hex (1" flat-to-flat at 1" = 0.1 mile scale)
- Physical hex size: 1" flat-to-flat @ 300 DPI (1" = 528ft scale)
- Use case: County maps, regional travel, wilderness exploration

**5. Travel - Province Scale** (Kingdom-level)
- Type: Hex grid
- Tile: 1 mile hex (5,280ft)
- Digital: 610 x 528 pixels per hex (1 pixel = 10ft - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per hex (1" flat-to-flat at 1" = 1 mile scale)
- Physical hex size: 1" flat-to-flat @ 300 DPI (1" = 1 mile scale)
- Use case: Province maps, large wilderness, kingdom regions

**6. Travel - Kingdom Scale** (Continental regions)
- Type: Hex grid
- Tile: 6 mile hex (31,680ft)
- Digital: 610 x 528 pixels per hex (1 pixel = 60ft - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per hex (1" flat-to-flat at 1" = 6 miles scale)
- Physical hex size: 1" flat-to-flat @ 300 DPI (1" = 6 miles scale)
- Use case: Kingdom maps, large seas, continental regions

**7. Travel - Continent Scale** (World maps)
- Type: Hex grid
- Tile: 60 mile hex (316,800ft)
- Digital: 610 x 528 pixels per hex (1 pixel = 600ft - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per hex (1" flat-to-flat at 1" = 60 miles scale)
- Physical hex size: 1" flat-to-flat @ 300 DPI (1" = 60 miles scale)
- Use case: Continent maps, ocean maps, world-scale travel

**8. Planetary - Realm Scale** (Planet surfaces)
- Type: Voxel (hex-based sphere)
- Tile: 100 mile voxel (528,000ft)
- Digital: Variable voxel rendering (1 pixel = 0.1 mile / 528ft - VTT display only)
- **Print (300 DPI):** 300 x 300 pixels per 100mi tile (1" flat-to-flat at 1" = 100 miles scale)
- Physical tile size: 1" flat-to-flat @ 300 DPI (1" = 100 miles scale, spherical projection)
- Use case: Planetary region maps, world globes, realm-scale exploration

**Special Scale - Interaction (Gridless):**
- **0. Interaction Voxel Scale** (Token-level detail)
- Type: Gridless voxel
- Dimensions: 600 x 600 pixels @ 10ppi OR 6000 x 6000 @ 100ppi
- Pixel ratio: 1 pixel = 0.1 inch (10ppi) or 0.01 inch (100ppi)
- Use case: Close-up token interactions, detailed object placement
- **Status:** Deferred to August 2026+ (advanced feature)

**Deferred to August 2026+ (Cosmic Scales):**
- Planet/Plane Scale (1,000 mile voxel)
- Orbital Space (6,000 mile voxel)
- Star System (60,000 mile voxel)
- Astronomical scales (AU-based)
- Inter-stellar scales (LY-based)
- Galactic scales (KLY-based)
- Universal scales (MLY-based)
- Multiverse (conceptual only)

### Admin: Scale Constants Implementation
- [ ] Create `src/lib/constants/vtt-scales.ts` with all scale definitions
- [ ] Define `WorldScale` enum (ARENA, BUILDING, SETTLEMENT, COUNTY, PROVINCE, KINGDOM, CONTINENT, REALM)
- [ ] Define `GridType` enum (SQUARE, HEX, VOXEL)
- [ ] Create scale metadata interface (dimensions, pixelRatio, gridType, useCase)
- [ ] Export scale lookup functions (getScaleByName, getPixelRatio, getDimensions)
- [ ] Add TypeScript types for scale system
- [ ] Document scale system in code comments

### Admin: Multiverse Organization
- [ ] Universes management page (`/universes`) - already exists
- [ ] Create/edit universe functionality
- [ ] Set universe metadata (name, description, genre)
- [ ] Assign universe to multiverse (optional)
- [ ] Universe list with hierarchy view
- [ ] Add "Create Universe" button and form

### Admin: World Creation & Organization
- [ ] Worlds management page (`/worlds`) - already exists
- [ ] Create world functionality
- [ ] **Select world scale dropdown** (populated from scale constants)
- [ ] Display scale metadata (grid type, pixel ratio, use case)
- [ ] Assign world to universe (dropdown of existing universes)
- [ ] Set world metadata (name, description, system)
- [ ] World → Universe relationship display in list view
- [ ] Validate world scale on creation
- [ ] Show scale icon/badge in world list
- [ ] Filter worlds by scale or universe

### Admin: RPG System Management
- [ ] Define supported RPG systems (D&D 5e, Cypher System)
- [ ] System selection during world creation
- [ ] System-specific settings/metadata
- [x] **FOUNDRY INTEGRATION COMPLETE** - Both D&D 5e and Cypher System supported
  - [x] Foundry Core Concepts module (system-agnostic framework)
  - [x] Foundry Core Concepts API (sync engine with adapter pattern)
  - [x] Foundry CFG 5e Bridge (D&D 5e adapter)
  - [x] Foundry CFG Cypher Bridge (Cypher System adapter) - **NEW**
  - [x] Multi-system database schema (installedSystems, gameSystem fields)
  - [x] CSRD data integration (103 descriptors, 4 types, 142 foci)
  - [ ] **TODO**: Web API endpoints for system selection (/api/foundry/systems)
  - [ ] **TODO**: Web UI for Foundry instance manager
  - [ ] **TODO**: Test both systems in parallel (5e world + Cypher world)

---

## Phase 2: GM Features (Week 3-6)

**Purpose:** GMs can create campaigns in existing worlds and prepare sessions.

**Access:** Admins + GMs only

### Campaign Management
- [ ] Campaign creation UI
- [ ] **Select existing world** (created by admins)
- [ ] Campaign inherits world's scale and system
- [ ] Invite players to campaign
- [ ] View campaign members list
- [ ] Set campaign status (planning, active, completed)
- [ ] Campaign list/browse page
- [ ] Campaign details page
- [ ] Validate: Only admin-created worlds selectable

### Session Management
- [ ] Create/schedule game sessions
- [ ] Session belongs to campaign (inherits world/scale)
- [ ] Join session link for players
- [ ] Basic session page (prep for VTT)
- [ ] Session scheduling UI
- [ ] Session list for campaign
- [ ] Session state management

### VTT Setup (GM Tools)
- [ ] Upload map image via Vercel Blob
- [ ] Display map as background layer
- [ ] **Align grid to world scale** (from world settings)
- [ ] Map scaling controls (based on world scale constants)
- [ ] Map image management
- [ ] Upload/manage token images
- [ ] Token library/selection (GM view)

### Combat Preparation (GM Tools)
- [ ] Create NPC/enemy tokens
- [ ] Set NPC HP and stats
- [ ] Initiative order setup
- [ ] Encounter planning UI

---

## Phase 3: Player Features (Week 7-10)

**Purpose:** Players can join campaigns, create characters, and play sessions.

**Access:** Admins + GMs + Players

### Character Creation
- [ ] Character sheet form (RPG system-specific)
- [ ] **System-driven by campaign's world** (D&D 5e, Cypher, etc.)
- [ ] Character belongs to campaign
- [ ] Save to database via API
- [ ] Character creation page UI
- [ ] Validation and error handling
- [ ] Character list/browse page

### Session Participation
- [ ] Join session via link
- [ ] See shared battle map
- [ ] View all tokens (players + NPCs)
- [ ] See current initiative order
- [ ] View roll history

### Player Actions (In-Session)
- [ ] Move own character token
- [ ] Roll dice (d4, d6, d8, d10, d12, d20, d100)
- [ ] Roll modifiers (+/- buttons)
- [ ] Advantage/disadvantage for d20
- [ ] Roll attacks (d20 + modifier)
- [ ] Roll damage (weapon dice + modifier)
- [ ] View own character HP
- [ ] View roll results (visible to everyone)

---

## Phase 4: VTT Rendering Engine (Week 5-8)

**Purpose:** Real-time collaborative battle map rendering.

**Access:** All users (in active sessions)

### Pixi.js Canvas Setup
- [ ] Install and configure Pixi.js v8
- [ ] Basic canvas in session page
- [ ] Pan and zoom controls
- [ ] **Grid overlay based on world scale** (uses vtt-scales.ts constants)
- [ ] Render square grids (ARENA, BUILDING scales)
- [ ] Render hex grids (SETTLEMENT, COUNTY, PROVINCE, KINGDOM, CONTINENT scales)
- [ ] Support voxel rendering prep (REALM scale - hex-based sphere)
- [ ] Canvas resize handling
- [ ] Touch/mobile gesture support
- [ ] Scale-aware rendering (pixel ratios from constants)
- [ ] Multi-resolution tile loading (600x600 @ 10ppi OR 6000x6000 @ 100ppi)

### Token System
- [ ] Place tokens on grid (GM only)
- [ ] Drag tokens to move (GM: any token, Player: own token)
- [ ] Store positions in database
- [ ] **Sync positions between players** (WebSocket or polling)
- [ ] Token selection/highlighting
- [ ] Token rotation (optional)
- [ ] Grid snapping based on scale

### Real-time Sync
- [ ] WebSocket connection for live sessions
- [ ] Token position updates
- [ ] Dice roll broadcasts
- [ ] Initiative order updates
- [ ] HP/status updates
- [ ] Handle disconnections gracefully

---

## Phase 5: Combat System (Week 9-12)

**Purpose:** Full combat workflow with initiative, attacks, and damage.

**Access:** All users (in active sessions)

### Dice Roller
- [ ] Dice roll UI component
- [ ] Roll history log (session-scoped)
- [ ] Roll animations/effects
- [ ] Broadcast rolls to all players
- [ ] GM vs Player roll visibility settings

### Combat Tracker
- [ ] Initiative roller (all participants)
- [ ] Initiative order list
- [ ] Turn indicator (whose turn is it?)
- [ ] HP tracking (current/max)
- [ ] Status effects (concentrating, prone, etc.)
- [ ] Combat tracker UI component
- [ ] Combat state management
- [ ] Next/previous turn controls (GM only)

### Combat Actions
- [ ] Roll to hit workflow
- [ ] Roll damage workflow
- [ ] Apply damage to target HP (GM only)
- [ ] Critical hits (roll dice twice)
- [ ] Attack UI and workflow
- [ ] Target selection
- [ ] Damage confirmation

---

## Infrastructure & Polish

### Testing
- [ ] E2E tests for admin world/universe creation
- [ ] E2E tests for GM campaign creation
- [ ] E2E tests for player character creation
- [ ] E2E tests for VTT rendering
- [ ] E2E tests for dice rolling
- [ ] E2E tests for combat tracker
- [ ] Test scale constants and grid rendering

### Performance
- [ ] Optimize Pixi.js rendering
- [ ] WebSocket connection management
- [ ] Database query optimization
- [ ] Image loading and caching
- [ ] Scale-based asset loading (only load necessary resolutions)

### UI/UX Polish
- [ ] Mobile responsiveness for all new pages
- [ ] Loading states
- [ ] Error handling and user feedback
- [ ] Accessibility improvements
- [ ] Dark/light theme support for all new components
- [ ] Role-based UI (show/hide features based on Admin/GM/Player)

### Documentation
- [ ] Document world scale system (reference VTTImageScaleGuidelines.md)
- [ ] Create developer guide for vtt-scales.ts constants
- [ ] Document pixel-to-scale mappings per grid type
- [ ] Document zoom behavior and multi-resolution loading
- [ ] Document admin world creation workflow
- [ ] Document GM campaign creation workflow (world selection)
- [ ] Document player workflow
- [ ] Add inline code comments with scale examples
- [ ] Create visual diagram of scale hierarchy

---

## Success Criteria

The test release is successful if:

1. **Admin can set up content hierarchy:**
   - Create universes and organize them
   - Create worlds with proper scales
   - Assign worlds to universes
   - World scales correctly define VTT grid sizes

2. **GM can run a session:**
   - Create campaign in existing admin-created world
   - Campaign inherits world's scale and system
   - Invite 3-5 players to campaign
   - Upload a battle map (aligned to world scale)
   - Place enemy tokens on map
   - Track initiative and HP

3. **Players can play:**
   - Create character in campaign (system-driven by world)
   - Join campaign and session
   - See shared map and all tokens
   - Move their token on scale-appropriate grid
   - Roll attacks and damage
   - See HP go down when hit

4. **Technical quality:**
   - No crashes during 2-hour session
   - Token positions sync within 2 seconds
   - Dice rolls are visible to everyone immediately
   - Grid rendering matches world scale exactly
   - Mobile-responsive (tablet works, phone is OK if clunky)

5. **Access control:**
   - Only admins can create worlds/universes
   - Only admins and GMs can create campaigns
   - All users can create characters and join sessions
   - Role-based UI properly shows/hides features

---

## Priority Order (Creator-First)

**Week 1-2:** Admin tools (universes, worlds, scales) - **FOUNDATION**
**Week 3-6:** GM tools (campaigns, sessions, VTT setup)
**Week 7-10:** Player tools (characters, session participation)
**Week 5-12:** VTT rendering & combat (parallel with GM/Player development)

**Key Principle:** Nothing can be created until the admin has set up the world hierarchy and scales. GMs select from existing worlds. Players create characters in existing campaigns.

---

---

## Code Cleanup (November 24, 2024)

**Removed External Dependencies:**
- [x] Deleted `/api/dev/verify` route (referenced non-existent `db` export)
- [x] Fixed variable name conflict in `/api/rpg/sessions` (`session` vs `authSession`)
- [x] Verified build errors resolved for these specific issues

**Remaining Build Issues:**
- Next.js 16 route handler type compatibility (params now Promise-based)
- Pre-existing TypeScript errors in archived packages
- These do not block development or runtime functionality

---

**Last Updated:** November 24, 2024
