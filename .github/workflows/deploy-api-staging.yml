# Deploy Core Concepts API to Staging Droplet
# Triggered manually or on push to staging branch with API changes

name: Deploy API - Staging

on:
  workflow_dispatch:
  push:
    branches:
      - staging
    paths:
      - 'packages/core-concepts-api/**'
      - '.github/workflows/deploy-api-staging.yml'

env:
  DROPLET_IP: ${{ secrets.STAGING_DROPLET_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}

jobs:
  deploy:
    name: Deploy to Staging Droplet
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Copy API files to Droplet
        run: |
          rsync -avz --delete \
            packages/core-concepts-api/ \
            root@${{ secrets.STAGING_DROPLET_IP }}:/opt/core-concepts-api/

      - name: Build and deploy on Droplet
        run: |
          ssh root@${{ secrets.STAGING_DROPLET_IP }} << 'EOF'
            cd /opt/core-concepts-api

            # Create .env if it doesn't exist
            if [ ! -f .env ]; then
              echo "Creating .env from template..."
              cp .env.example .env
              echo "WARNING: Update .env with production values!"
            fi

            # Build and restart containers
            docker compose -f docker-compose.staging.yml build --no-cache api
            docker compose -f docker-compose.staging.yml up -d

            # Run migrations
            docker compose -f docker-compose.staging.yml exec -T api npx prisma migrate deploy

            # Health check
            sleep 5
            curl -f http://localhost:3001/health || exit 1

            echo "Deployment complete!"
          EOF

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Check logs."
