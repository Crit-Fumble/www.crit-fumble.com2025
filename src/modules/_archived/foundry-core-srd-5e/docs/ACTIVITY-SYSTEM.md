# Activity System

## Overview

The Activity System defines structured creature actions during different gameplay modes, particularly during resting and downtime periods. This system captures the SRD's definitions of "light activity" and general "activity" concepts, providing a framework for tracking what creatures can do without interrupting rest or engaging in strenuous exertion.

## SRD References

### Light Activity (Primary Source)
The SRD defines "light activity" in two key locations:

**Long Rest** (rulesglossary/rulesdefinitions/96-LongRest.md):
> "During a Long Rest, you sleep for at least 6 hours and perform no more than 2 hours of light activity, such as reading, talking, eating, or standing watch."

**Wish Spell** (spells/spelldescriptions/Wish.md):
> "For each of those days that you spend resting and doing nothing more than light activity, your remaining recovery time decreases by 2 days."

### Activity Types in SRD

**Course of Activity** (Suggestion spell):
> "You suggest a course of activity—described in no more than 25 words"

**Physical Exertion** (Long Rest interruptions):
> "1 hour of walking or other physical exertion" interrupts a Long Rest

**Strenuous Activity**: Referenced in context of rest interruption and opposed to light activity

## Activity Categories

### 1. Light Activities
Activities that do not prevent resting or recovery. Maximum 2 hours during an 8-hour Long Rest.

### 2. Strenuous Activities
Activities that require significant physical or mental exertion. Interrupt rest if sustained for 1 hour or more.

### 3. Rest-Breaking Activities
Actions that immediately interrupt rest periods regardless of duration.

## Light Activity Types

### Reading
**Description**: Studying texts, scrolls, maps, or other written materials.

**Properties**:
- Duration: Up to 2 hours during Long Rest
- Physically passive: Yes
- Mentally engaging: Moderate
- Position: Seated or reclining
- Prerequisites: Light source (if needed), literacy, readable material

**SRD Rule References**:
- Long Rest (96-LongRest.md): Explicitly listed as light activity
- Does not interrupt rest when limited to 2 hours

**Compatible With**:
- Long Rest sleep phase: No (cannot read while sleeping)
- Long Rest waking phase: Yes (up to 2 hours)
- Short Rest: Yes (entire duration if desired)
- Downtime: Yes (extended reading for research, learning)

**Game Effects**:
- May be used for research during downtime
- Can satisfy requirements for learning spells or languages
- Supports watch rotation planning

**Example Uses**:
- Reading spellbook to prepare new spells
- Studying a map of the region
- Reviewing historical texts for lore
- Reading religious scripture at a temple

---

### Talking
**Description**: Conversation, discussion, storytelling, prayer, or other verbal communication.

**Properties**:
- Duration: Up to 2 hours during Long Rest
- Physically passive: Yes
- Mentally engaging: Low to Moderate
- Position: Any (seated, standing, reclining)
- Prerequisites: Shared language or communication method

**SRD Rule References**:
- Long Rest (96-LongRest.md): Explicitly listed as light activity
- Combat (07-Combat.md): "Brief utterances and gestures" during combat turn
- Does not interrupt rest when limited to 2 hours

**Compatible With**:
- Long Rest sleep phase: No (cannot talk while sleeping)
- Long Rest waking phase: Yes (up to 2 hours)
- Short Rest: Yes (entire duration if desired)
- Downtime: Yes (extended conversation, negotiations, storytelling)

**Game Effects**:
- Enables party planning during rest
- Supports social interaction and roleplay
- May be used for Influence actions during downtime
- Can fulfill verbal components of certain activities

**Example Uses**:
- Discussing tomorrow's plans around the campfire
- Sharing stories during an evening at the inn
- Prayer or meditation with verbal components
- Teaching a companion a new language

---

### Eating
**Description**: Consuming food and drink for sustenance and enjoyment.

**Properties**:
- Duration: Up to 2 hours during Long Rest (typically much less)
- Physically passive: Yes
- Mentally passive: Yes
- Position: Seated or reclining
- Prerequisites: Food and water available

**SRD Rule References**:
- Long Rest (96-LongRest.md): Explicitly listed as light activity
- Facilities can provide "food" benefit
- Does not interrupt rest

**Compatible With**:
- Long Rest sleep phase: No (cannot eat while sleeping)
- Long Rest waking phase: Yes (up to 2 hours)
- Short Rest: Yes (entire duration if desired)
- Downtime: Yes (can include extended meals, feasts)

**Game Effects**:
- Satisfies daily food/water requirements
- May provide morale or social benefits
- Can be combined with "talking" for meals with conversation
- Required for survival (typically 1 pound food, 1 gallon water per day)

**Example Uses**:
- Eating breakfast before breaking camp
- Sharing a meal at an inn's common room
- Consuming trail rations during a short rest
- Attending a feast during downtime

---

### Standing Watch
**Description**: Maintaining alertness to guard against threats, observing surroundings for danger.

**Properties**:
- Duration: Up to 2 hours during Long Rest (typically in shifts)
- Physically passive: Mostly (standing or sitting alert)
- Mentally engaging: Moderate to High (requires alertness)
- Position: Standing, sitting, or pacing
- Prerequisites: Consciousness, functional senses

**SRD Rule References**:
- Long Rest (96-LongRest.md): Explicitly listed as light activity
- Short Rest (125-ShortRest.md): Mentioned as context for interruptions
- Wilderness Campsite: Watch Post facility provides "security" and "alertness"
- Does not interrupt rest when limited to 2 hours

**Compatible With**:
- Long Rest sleep phase: No (requires consciousness)
- Long Rest waking phase: Yes (up to 2 hours, typically in 2-hour shifts)
- Short Rest: Yes (can watch during entire short rest)
- Downtime: Yes (extended guard duty, sentry work)

**Game Effects**:
- Allows Perception checks to detect threats
- Enables party to rotate watch shifts (4 party members = 8 hours covered)
- May grant advantage to Initiative if ambush is detected
- Security facilities can enhance watch effectiveness

**Example Uses**:
- Taking first watch while party sleeps at campsite
- Guarding the door during a short rest in a dungeon
- Maintaining lookout at a watch post
- Observing the road from an inn window

---

## Strenuous Activities

### Walking / Travel
**Description**: Sustained movement on foot, whether exploration, travel, or patrol.

**Properties**:
- Duration threshold: 1 hour interrupts Long Rest
- Physically demanding: Yes
- Mentally variable: Low to Moderate
- Prerequisites: Mobile, conscious

**SRD Rule References**:
- Long Rest (96-LongRest.md): "1 hour of walking or other physical exertion" interrupts rest

**Effects**:
- Interrupts Long Rest if sustained for 1 hour
- Compatible with Short Rest only if brief (less than 1 hour)
- Primary mode during exploration and travel
- May require exhaustion checks in harsh environments

---

### Combat / Physical Exertion
**Description**: Fighting, heavy labor, athletics, or other physically demanding actions.

**Properties**:
- Duration threshold: Variable (combat starts immediately interrupt)
- Physically demanding: High
- Mentally demanding: Moderate to High
- Prerequisites: Conscious, capable of action

**SRD Rule References**:
- Long Rest (96-LongRest.md): Listed as "other physical exertion" that interrupts rest after 1 hour
- Manual of Golems: Notes 30 days of reading/studying (light activity for extended periods)

**Effects**:
- Immediately interrupts rest in most cases
- Triggers Initiative rolls
- May cause exhaustion or damage
- Incompatible with rest periods

---

### Spellcasting (Non-Cantrip)
**Description**: Casting spells above cantrip level, requiring spell slot expenditure.

**Properties**:
- Duration: Instantaneous to minutes
- Mentally demanding: High
- Physically variable: Low to Moderate
- Prerequisites: Spellcasting ability, spell slots

**SRD Rule References**:
- Long Rest (96-LongRest.md): "Casting a spell other than a cantrip" interrupts Long Rest
- Short Rest (125-ShortRest.md): Any spell casting interrupts Short Rest

**Effects**:
- Immediately interrupts Long Rest
- Immediately interrupts Short Rest
- Consumes spell slot (if not cantrip)
- May have material component costs

**Note**: Cantrips do NOT interrupt Short Rest

---

## Rest-Breaking Activities

These actions immediately interrupt both Short Rest and Long Rest:

1. **Rolling Initiative** - Entering combat
2. **Taking Damage** - Any hit point loss
3. **Casting Spells** (non-cantrip for Long Rest, any spell for Short Rest)
4. **1 Hour Walking/Physical Exertion** - Sustained strenuous activity

**Recovery After Interruption**:
- If rested at least 1 hour before interruption → gain Short Rest benefits
- Can resume Long Rest immediately after interruption
- Each interruption adds 1 hour to Long Rest completion time

## Activity Schema

```typescript
/**
 * Base activity type classification
 */
type ActivityIntensity =
  | 'light'        // Does not interrupt rest (max 2hr during Long Rest)
  | 'strenuous'    // Interrupts rest after threshold
  | 'breaking';    // Immediately interrupts rest

/**
 * Activity category for mechanical effects
 */
type ActivityCategory =
  | 'mental'       // Reading, studying, research
  | 'social'       // Talking, performing, negotiating
  | 'physical'     // Walking, combat, athletics
  | 'sustenance'   // Eating, drinking
  | 'vigilance'    // Standing watch, perception
  | 'spellcasting' // Casting spells
  | 'rest';        // Sleeping, recuperating

/**
 * Gameplay mode when activity typically occurs
 */
type ActivityMode =
  | 'combat'       // During combat encounters
  | 'exploration'  // During dungeon/wilderness exploration
  | 'social'       // During roleplay and interaction
  | 'downtime'     // During extended rest periods
  | 'rest';        // During Short/Long Rest

/**
 * Complete activity definition
 */
interface Activity {
  id: string;
  name: string;
  description: string;

  // Classification
  intensity: ActivityIntensity;
  category: ActivityCategory;
  modes: ActivityMode[];

  // Properties
  properties: {
    maxDurationDuringLongRest?: number; // Hours, undefined if not allowed
    interruptThreshold?: number;         // Hours until interruption
    physicalDemand: 'none' | 'low' | 'moderate' | 'high';
    mentalDemand: 'none' | 'low' | 'moderate' | 'high';
    requiresConsciousness: boolean;
    compatiblePositions: ('standing' | 'sitting' | 'reclining' | 'prone')[];
  };

  // Prerequisites
  prerequisites?: string[];

  // SRD References
  srdReferences: {
    source: string;      // File path or rule name
    quote?: string;      // Exact quote from SRD
    page?: string;       // Page reference if applicable
  }[];

  // Mechanical Effects
  effects?: {
    interruptsLongRest: boolean;
    interruptsShortRest: boolean;
    grantsRestBenefits: boolean;
    enablesRecovery: boolean;
  };

  // Facility Integration
  facilitiesProviding?: string[];    // Facility IDs that enable/enhance
  facilitiesRequired?: string[];     // Facility IDs required to perform

  // Examples
  examples?: string[];
}
```

## Light Activity Examples (Full Schema)

```json
{
  "id": "activity-reading",
  "name": "Reading",
  "description": "Studying texts, scrolls, maps, or other written materials",
  "intensity": "light",
  "category": "mental",
  "modes": ["downtime", "rest"],
  "properties": {
    "maxDurationDuringLongRest": 2,
    "physicalDemand": "none",
    "mentalDemand": "moderate",
    "requiresConsciousness": true,
    "compatiblePositions": ["sitting", "reclining"]
  },
  "prerequisites": [
    "Light source (if needed)",
    "Literacy in language",
    "Readable material available"
  ],
  "srdReferences": [
    {
      "source": "rulesglossary/rulesdefinitions/96-LongRest.md",
      "quote": "perform no more than 2 hours of light activity, such as reading, talking, eating, or standing watch"
    }
  ],
  "effects": {
    "interruptsLongRest": false,
    "interruptsShortRest": false,
    "grantsRestBenefits": false,
    "enablesRecovery": false
  },
  "examples": [
    "Reading spellbook to prepare new spells",
    "Studying a regional map",
    "Reviewing historical texts for lore"
  ]
}
```

```json
{
  "id": "activity-standing-watch",
  "name": "Standing Watch",
  "description": "Maintaining alertness to guard against threats",
  "intensity": "light",
  "category": "vigilance",
  "modes": ["rest", "downtime"],
  "properties": {
    "maxDurationDuringLongRest": 2,
    "physicalDemand": "low",
    "mentalDemand": "high",
    "requiresConsciousness": true,
    "compatiblePositions": ["standing", "sitting"]
  },
  "prerequisites": [
    "Consciousness",
    "Functional senses"
  ],
  "srdReferences": [
    {
      "source": "rulesglossary/rulesdefinitions/96-LongRest.md",
      "quote": "perform no more than 2 hours of light activity, such as reading, talking, eating, or standing watch"
    }
  ],
  "effects": {
    "interruptsLongRest": false,
    "interruptsShortRest": false,
    "grantsRestBenefits": false,
    "enablesRecovery": false
  },
  "facilitiesProviding": ["facility-watch-post"],
  "examples": [
    "Taking first watch at wilderness campsite",
    "Guarding the door during dungeon short rest",
    "Observing the road from inn window"
  ]
}
```

## Integration with Downtime Mode

### Downtime Activities
Downtime represents extended periods (days, weeks, months) between adventures. The Activity System provides the foundation for downtime tracking.

**Extended Light Activities During Downtime**:
- **Reading**: Research, learning languages, studying spells (Manual of Golems: 30 days)
- **Talking**: Negotiations, teaching, social influence, gathering information
- **Eating**: Participating in social meals, feasts, building relationships
- **Standing Watch**: Guard duty, sentry work, security contracts

**Downtime-Specific Activities**:
- **Crafting**: Creating items, brewing potions, scribing scrolls
- **Training**: Learning proficiencies, languages, or tools
- **Research**: Discovering lore, solving mysteries
- **Carousing**: Building reputation, making contacts
- **Religious Service**: Worship, ritual participation

### Rhythm of Play Integration

From "Rhythm of Play" (playingthegame/00-RhythmofPlay.md):
> "The three main pillars of D&D play are social interaction, exploration, and combat."

Activities map to these pillars:
- **Social Interaction**: Talking, eating (social meals), entertainment activities
- **Exploration**: Standing watch, reading (maps/lore), travel activities
- **Combat**: Combat actions, physical exertion, immediate responses

**Activity Resolution**:
> "Outside combat, the GM ensures that every character has a chance to act and decides how to resolve their activity."

Activities provide structure for GM rulings on:
- What interrupts rest vs. what's permissible
- How much time activities consume
- What prerequisites or facilities are needed
- What game effects result from activities

## Foundry VTT Integration

### Actor Flags

```typescript
interface ActorActivityFlags {
  "foundry-core-srd-5e": {
    activity: {
      current?: string;           // Current activity ID
      startTime?: number;          // Game time when started
      plannedDuration?: number;    // Hours planned

      // Rest Integration
      duringRest?: {
        restType: 'short' | 'long';
        restStartTime: number;
        lightActivitiesPerformed: {
          activityId: string;
          duration: number;        // Hours
          startTime: number;
        }[];
        totalLightActivityTime: number; // Sum of light activities
        interruptions: number;     // Count of interruptions
      };

      // Downtime Integration
      duringDowntime?: {
        downtimeStartDate: string;
        activities: {
          activityId: string;
          daysSpent: number;
          result?: string;        // GM notes on outcome
        }[];
      };
    }
  }
}
```

### Combat Integration

Track when activities are interrupted by combat:
- Rolling Initiative interrupts rest
- Record rest progress before interruption
- Grant Short Rest benefits if ≥1 hour had elapsed

### Watch Rotation

Support automatic watch rotation during Long Rest:
```typescript
interface WatchRotation {
  totalDuration: number;      // 8 hours for Long Rest
  shiftDuration: number;      // 2 hours per shift (max light activity)
  shifts: {
    actorId: string;
    startHour: number;
    endHour: number;
    activityId: 'activity-standing-watch';
  }[];
}

// Example: 4 party members, 2-hour shifts
// Shift 1 (0-2hr): Actor A watches, B/C/D sleep
// Shift 2 (2-4hr): Actor B watches, A/C/D sleep
// Shift 3 (4-6hr): Actor C watches, A/B/D sleep
// Shift 4 (6-8hr): Actor D watches, A/B/C sleep
```

## Implementation Notes

1. **Activity Tracking**: Use Actor flags to track current activity and duration
2. **Rest Validation**: Validate that light activities don't exceed 2 hours during Long Rest
3. **Interruption Handling**: Automatically record interruptions and adjust rest completion time
4. **Facility Enhancement**: Facilities can modify activity effectiveness (e.g., Watch Post enhances standing watch)
5. **Downtime Journal**: Create Journal Entries to track extended downtime activities
6. **UI Indicators**: Show current activity status on character sheets/tokens

## Future Expansion (cfg-5e Module)

- **Downtime Activity Rolls**: Skill checks and complications
- **Activity Automation**: Auto-advance time based on activity duration
- **Watch Schedule UI**: Visual interface for setting watch rotations
- **Activity Templates**: Pre-configured activity sets for common scenarios
- **Rest Timer**: Visual countdown for rest completion with interruption tracking
- **Facility Discovery**: Track which facilities characters have discovered/unlocked
