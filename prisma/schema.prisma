// Prisma schema for Crit-Fumble TTRPG Platform
// See docs/DATABASE_SCHEMA.md for complete schema documentation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Authentication & User Management (Auth.js required tables)
// ============================================================================

// User tier levels for feature access and monthly Crit-Coin allocations
// Order matters: LEGACY (-1), FREE (0), PRO (1), PLUS (2), MAX (3)
enum UserTier {
  LEGACY // Admin-only tier for 5+ year members, grants 5 coins/month
  FREE // Default tier - standard features, 0 coins/month
  PRO // Paid tier - enhanced features (stubbed, TBD)
  PLUS // Paid tier - advanced features (stubbed, TBD)
  MAX // Paid tier - all features (stubbed, TBD)
}

// CritUser - Platform/website user (auth, profile, payments, platform features)
// NOTE: RPG game data is stored in the separate Core Concepts database
// CritUser links to Core Concepts player via coreConceptsPlayerId (one-way reference)
// NOTE: OAuth accounts are stored in the Account model (NextAuth standard)
// Multiple accounts from the same or different providers can be linked to one CritUser
model CritUser {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // User info
  username String  @unique
  email    String? @unique

  // Link to Core Concepts player (one-way reference, no Prisma relation)
  // This links the website user to their Core Concepts/RPG identity
  // Core Concepts database is completely independent and doesn't reference this table
  coreConceptsPlayerId String? @unique @map("core_concepts_player_id")

  // Profile completion status
  profileCompleted Boolean @default(false) @map("profile_completed")
  avatarUrl        String? @map("avatar_url") // User's chosen avatar (can override provider avatars)
  displayName      String? @map("display_name") // User's display name (defaults to username if not set)
  bio              String? // Short user biography/description

  // User roles (owners have all roles by default)
  // Possible values: 'GameMaster', 'Storyteller', 'Worldbuilder', 'Creator', 'Moderator', 'Admin'
  roles      Json    @default("[]") @db.JsonB
  viewAsRole String? @map("view_as_role") // Owner-only: view site as different role for testing

  // DEPRECATED: Provider-specific fields (kept for backward compatibility during migration)
  // These will be removed after migrating data to Account.metadata
  // To get linked accounts, use: user.accounts relation
  discordId       String? @unique @map("discord_id")
  discordUsername String? @map("discord_username")
  discordAvatar   String? @map("discord_avatar")

  githubId       String? @unique @map("github_id")
  githubUsername String? @map("github_username")
  githubAvatar   String? @map("github_avatar")

  twitchId       String? @unique @map("twitch_id")
  twitchUsername String? @map("twitch_username")
  twitchAvatar   String? @map("twitch_avatar")

  battlenetId        String? @unique @map("battlenet_id")
  battlenetBattletag String? @map("battlenet_battletag")

  steamId       String? @unique @map("steam_id")
  steamUsername String? @map("steam_username")
  steamAvatar   String? @map("steam_avatar")

  fandomId       String? @unique @map("fandom_id")
  fandomUsername String? @map("fandom_username")

  // Foundry VTT API Integration (not OAuth-based)
  foundryApiUrl   String? @map("foundry_api_url") // User's Foundry instance URL
  foundryApiKey   String? @map("foundry_api_key") // Encrypted API key
  foundryUsername String? @map("foundry_username")
  foundryUserId   String? @map("foundry_user_id")

  // World Anvil OAuth
  worldAnvilId           String?   @unique @map("world_anvil_id")
  worldAnvilUsername     String?   @map("world_anvil_username")
  worldAnvilToken        String?   @map("world_anvil_token") // Encrypted
  worldAnvilRefreshToken String?   @map("world_anvil_refresh_token") // Encrypted
  worldAnvilTokenExpires DateTime? @map("world_anvil_token_expires")

  // Primary account selection for display (optional)
  // Points to an Account.id to use for username/avatar display
  primaryAccountId String? @map("primary_account_id")

  // Stripe
  stripeCustomerId String? @unique @map("stripe_customer_id")

  // User preferences
  settings Json @default("{}") @db.JsonB

  // Status
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")

  // Tier and role management
  tier                    UserTier  @default(FREE) // Subscription/feature tier
  isAdmin                 Boolean   @default(false) @map("is_admin") // Admin privileges (can manage users, content, etc.)
  isOwner                 Boolean   @default(false) @map("is_owner") // Owner privileges (full platform control)
  lastMonthlyCoinsGranted DateTime? @map("last_monthly_coins_granted") // Last time monthly tier coins were granted

  // Developer privileges (local development only)
  // When all three verified fields match DEV_ env vars, user gets admin privileges
  verifiedPhone   String? @map("verified_phone")
  verifiedEmail   String? @map("verified_email")
  verifiedDiscord String? @map("verified_discord")

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // Platform sessions (immutable audit log)
  sessionLogs CritSessionLog[]

  // Platform relations (Crit tables)
  coinTransactions        CritCoinTransaction[]
  storyCreditTransactions CritStoryCreditTransaction[]
  purchases               CritPurchase[]
  virtualDesktopSessions  CritVirtualDesktopSession[]
  apiKeys                 CritApiKey[]

  // Multiverse/Universe/Space ownership (Crit expansion features)
  ownedMultiverses   CritMultiverse[]
  ownedUniverses     CritUniverse[]
  ownedOrbitalSpaces CritOrbitalSpace[]

  // RPG World ownership (worlds are owned at platform level)

  // Asset ownership (marketplace assets)
  ownedAssets CritAsset[]

  // Link to game identity (1:1 relationship)

  // Core Concepts Wiki (admin-authored documentation)
  authoredWikiPages   CoreConceptWiki[]         @relation("AuthoredWikiPages")
  lastEditedWikiPages CoreConceptWiki[]         @relation("WikiLastEditor")
  wikiRevisions       CoreConceptWikiRevision[]

  // World-specific Wiki (user-authored world documentation)

  @@index([discordId])
  @@index([githubId])
  @@index([twitchId])
  @@index([battlenetId])
  @@index([steamId])
  @@index([fandomId])
  @@index([worldAnvilId])
  @@index([stripeCustomerId])
  @@index([coreConceptsPlayerId])
  @@index([deletedAt])
  @@map("crit_users")

  // NOTE: RPG-related relations are now in the separate Core Concepts database
  // Link to Core Concepts player is via coreConceptsPlayerId field (one-way reference)
}

// ============================================================================
// Core Concepts Wiki & Documentation
// ============================================================================

// CoreConceptWiki - Admin-editable wiki pages for game rules and Core Concepts
// Public-facing with three audience versions: GM, Player, World Builder
model CoreConceptWiki {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Page identification
  slug      String  @unique @db.VarChar(200) // URL-friendly identifier
  title     String  @db.VarChar(200)
  category  String  @db.VarChar(100) // 'players', 'teams', 'roles', 'scales', 'rules', etc.
  icon      String? @db.VarChar(50) // Emoji or icon identifier
  sortOrder Int     @default(0) @map("sort_order") // For ordering pages in navigation

  // Content for different audiences (Markdown format)
  gmContent      String @map("gm_content") @db.Text // Full details for Game Masters
  playerContent  String @map("player_content") @db.Text // Simplified for Players
  builderContent String @map("builder_content") @db.Text // In-depth for World Builders

  // SEO & meta
  description String? @db.Text // Short description for meta tags
  keywords    String? @db.Text // Comma-separated keywords

  // Publishing
  isPublished Boolean   @default(false) @map("is_published")
  publishedAt DateTime? @map("published_at")

  // Authorship
  authorId String   @map("author_id")
  author   CritUser @relation("AuthoredWikiPages", fields: [authorId], references: [id])

  lastEditedById String?   @map("last_edited_by_id")
  lastEditedBy   CritUser? @relation("WikiLastEditor", fields: [lastEditedById], references: [id])

  // Versioning (for AI-assisted edits and rollback)
  revisions CoreConceptWikiRevision[]

  // AI generation metadata
  aiAssisted       Boolean @default(false) @map("ai_assisted") // Was AI used to generate/edit content?
  aiModel          String? @db.VarChar(100) // e.g., "claude-sonnet-4", "gpt-4"
  aiPromptMetadata Json    @default("{}") @map("ai_prompt_metadata") @db.JsonB // Store prompt info for reference

  @@index([slug])
  @@index([category])
  @@index([authorId])
  @@index([isPublished])
  @@index([deletedAt])
  @@map("core_concept_wiki")
}

// CoreConceptWikiRevision - Version history for wiki pages
// Allows rollback and tracking of AI-assisted edits
model CoreConceptWikiRevision {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Link to parent wiki page
  wikiPageId String          @map("wiki_page_id")
  wikiPage   CoreConceptWiki @relation(fields: [wikiPageId], references: [id], onDelete: Cascade)

  // Revision metadata
  versionNumber Int    @map("version_number") // Incremental version counter
  changeNote    String @default("") @db.Text // What changed in this revision

  // Snapshot of content at this revision
  gmContent      String @map("gm_content") @db.Text
  playerContent  String @map("player_content") @db.Text
  builderContent String @map("builder_content") @db.Text

  // Editor info
  editorId String   @map("editor_id")
  editor   CritUser @relation(fields: [editorId], references: [id])

  // AI metadata
  aiAssisted       Boolean @default(false) @map("ai_assisted")
  aiModel          String? @db.VarChar(100)
  aiPromptMetadata Json    @default("{}") @map("ai_prompt_metadata") @db.JsonB

  @@index([wikiPageId])
  @@index([editorId])
  @@index([createdAt])
  @@map("core_concept_wiki_revisions")
}

// ============================================================================
// Core Concepts (In-Game)
// ============================================================================

// RpgPlayer - In-game player identity (characters, campaigns, game actions)
// RPG tables are platform-agnostic and do not reference Crit tables

// Auth.js required tables
// Account - OAuth provider accounts linked to a CritUser
// Multiple accounts can be linked to one user (even from the same provider)
// This is the source of truth for linked accounts
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  // Timestamps for account linking
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Provider-specific metadata (username, avatar, email, etc.)
  // Schema varies by provider, stored as JSON
  // Example for Discord: { "username": "user#1234", "avatar": "https://...", "email": "user@example.com" }
  // Example for GitHub: { "login": "username", "avatar_url": "https://...", "email": "user@example.com" }
  // Example for Twitch: { "preferred_username": "username", "picture": "https://...", "email": "user@example.com" }
  metadata Json @default("{}") @db.JsonB

  // Display name override (optional, for user customization)
  displayName String? @map("display_name")

  user CritUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider, userId]) // For efficient queries like "get all Discord accounts for user"
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  // Activity tracking
  createdAt      DateTime @default(now()) @map("created_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")
  ipAddress      String?  @map("ip_address") @db.VarChar(45) // IPv6 max length
  userAgent      String?  @map("user_agent") @db.Text

  user CritUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActivityAt])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// Player Session Audit Log (Immutable, Write-Only)
// ============================================================================

model CritSessionLog {
  // Incremental ID (never reused, never deleted)
  id BigInt @id @default(autoincrement())

  // Timestamps (IMMUTABLE - no updated_at or deleted_at)
  createdAt DateTime @default(now()) @map("created_at")

  // Player reference
  playerId String @map("player_id")

  // Session token (unique per session)
  sessionToken String @map("session_token") @db.VarChar(500)

  // Session metadata
  ipAddress   String? @map("ip_address") @db.VarChar(45) // IPv6 max length
  userAgent   String? @map("user_agent") @db.Text
  loginMethod String  @map("login_method") @db.VarChar(50) // 'discord', 'world_anvil', etc.

  // Session expiration (1 month from creation)
  expiresAt DateTime @map("expires_at")

  // Last activity timestamp (updated but record never deleted)
  lastActivityAt DateTime @default(now()) @map("last_activity_at")

  // Status (for session validity check)
  isValid Boolean @default(true) @map("is_valid") // Can be set to false, but never deleted

  // Logout tracking (if user explicitly logged out)
  loggedOutAt DateTime? @map("logged_out_at")

  // Additional metadata
  metadata Json @default("{}")

  user CritUser @relation(fields: [playerId], references: [id], onDelete: Restrict)

  @@index([playerId])
  @@index([sessionToken])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([isValid])
  @@map("player_sessions")
}

// ============================================================================
// Crit-Coin Economy & Monetization (Non-Exportable, Private User Data)
// ============================================================================

model CritCoinTransaction {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  // NO updated_at or deleted_at - transactions are IMMUTABLE

  playerId        String @map("player_id")
  transactionType String @map("transaction_type") // 'credit' or 'debit'
  amount          Int
  balanceAfter    Int    @map("balance_after")
  description     String @db.VarChar(500)

  // Product reference
  productId String?      @map("product_id")
  product   CritProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Stripe payment reference
  stripePaymentIntentId String? @map("stripe_payment_intent_id")
  stripeChargeId        String? @map("stripe_charge_id")

  // Expiration (for promotional credits)
  expiresAt DateTime? @map("expires_at")

  // Additional metadata
  metadata Json @default("{}")

  user CritUser @relation(fields: [playerId], references: [id], onDelete: Restrict)

  @@index([playerId])
  @@index([createdAt])
  @@index([productId])
  @@index([expiresAt])
  @@index([transactionType])
  @@index([stripePaymentIntentId])
  @@map("crit_coin_transactions")
}

// Story Credits - Earned currency that can be cashed out
model CritStoryCreditTransaction {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  // NO updated_at or deleted_at - IMMUTABLE

  playerId        String  @map("player_id")
  transactionType String  @map("transaction_type") // 'earned', 'spent_redemption', 'spent_payout'
  amount          Decimal @db.Decimal(10, 2) // Story Credits (can be fractional)
  balanceAfter    Decimal @map("balance_after") @db.Decimal(10, 2)
  description     String  @db.VarChar(500)

  // Source tracking
  source String @db.VarChar(100) // 'gm_session', 'content_approved', 'artwork_approved', 'asset_approved', etc

  // Optional references
  sessionId String?      @map("session_id")
  session   CritSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  contentId String? @map("content_id") // Reference to approved content (future table)

  // Payout tracking (if cashed out via Stripe Connect)
  stripeTransferId String? @map("stripe_transfer_id") @db.VarChar(255)
  payoutStatus     String? @map("payout_status") @db.VarChar(50) // 'pending', 'processing', 'completed', 'failed'

  // Redemption tracking (if converted to Crit-Coins)
  redemptionTransactionId String? @map("redemption_transaction_id") // Links to CritCoinTransaction if redeemed

  // Metadata for audit trail
  metadata Json @default("{}")

  user CritUser @relation(fields: [playerId], references: [id], onDelete: Restrict)

  @@index([playerId])
  @@index([createdAt])
  @@index([source])
  @@index([stripeTransferId])
  @@index([payoutStatus])
  @@index([transactionType])
  @@map("story_credit_transactions")
}

model CritProduct {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Product identification
  sku         String  @unique @db.VarChar(100)
  name        String  @db.VarChar(255)
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Product type
  productType     String  @map("product_type") @db.VarChar(50) // 'crit_coins', 'virtual_desktop', 'ai_credits'
  productCategory String? @map("product_category") @db.VarChar(50)

  // Pricing
  priceUsd       Decimal? @map("price_usd") @db.Decimal(10, 2)
  priceCritCoins Int?     @map("price_crit_coins")

  // Product values
  critCoinAmount    Int? @map("crit_coin_amount")
  vdDurationMinutes Int? @map("vd_duration_minutes")
  aiGenerationCount Int? @map("ai_generation_count")

  // Availability
  isActive       Boolean   @default(true) @map("is_active")
  isFeatured     Boolean   @default(false) @map("is_featured")
  availableFrom  DateTime? @map("available_from")
  availableUntil DateTime? @map("available_until")
  maxPurchases   Int?      @map("max_purchases_per_user")

  // Stripe integration
  stripeProductId String? @map("stripe_product_id") @db.VarChar(255)
  stripePriceId   String? @map("stripe_price_id") @db.VarChar(255)

  // Metadata
  features     Json    @default("[]")
  metadata     Json    @default("{}")
  displayOrder Int     @default(0) @map("display_order")
  imageUrl     String? @map("image_url") @db.Text

  // Relations
  transactions CritCoinTransaction[]
  purchases    CritPurchase[]
  vdSessions   CritVirtualDesktopSession[]

  @@index([sku])
  @@index([productType])
  @@index([isActive])
  @@index([deletedAt])
  @@index([stripeProductId])
  @@map("crit_products")
}

model CritPurchase {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playerId  String @map("player_id")
  productId String @map("product_id")

  paymentMethod   String   @map("payment_method") @db.VarChar(50)
  amountUsd       Decimal? @map("amount_usd") @db.Decimal(10, 2)
  amountCritCoins Int?     @map("amount_crit_coins")

  // Stripe details
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(255)
  stripeInvoiceId       String? @map("stripe_invoice_id") @db.VarChar(255)
  stripeReceiptUrl      String? @map("stripe_receipt_url") @db.Text

  status        String  @default("completed") @db.VarChar(50)
  transactionId String? @map("transaction_id")

  metadata Json @default("{}")

  user    CritUser    @relation(fields: [playerId], references: [id], onDelete: Restrict)
  product CritProduct @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([playerId])
  @@index([productId])
  @@index([createdAt])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@map("crit_purchases")
}

model CritVirtualDesktopSession {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  playerId  String  @map("player_id")
  productId String? @map("product_id")

  purchasedDurationMinutes Int @map("purchased_duration_minutes")

  // Session timing
  startedAt      DateTime? @map("started_at")
  scheduledEndAt DateTime? @map("scheduled_end_at")
  endedAt        DateTime? @map("ended_at")

  // Status
  status String @default("pending") @db.VarChar(50)

  // Digital Ocean droplet info
  dropletId     String? @map("droplet_id") @db.VarChar(255)
  dropletIp     String? @map("droplet_ip") @db.VarChar(50)
  dropletRegion String  @default("nyc3") @map("droplet_region") @db.VarChar(50)
  dropletSize   String  @default("g-2vcpu-8gb") @map("droplet_size") @db.VarChar(50)

  // Access credentials (encrypted)
  vncPasswordEncrypted String? @map("vnc_password_encrypted") @db.Text
  rdpPasswordEncrypted String? @map("rdp_password_encrypted") @db.Text
  accessUrl            String? @map("access_url") @db.Text

  // Usage tracking
  actualDurationMinutes Int?    @map("actual_duration_minutes")
  critCoinsSpent        Int     @map("crit_coins_spent")
  transactionId         String? @map("transaction_id")

  // Performance metrics
  connectionCount Int       @default(0) @map("connection_count")
  lastActivityAt  DateTime? @map("last_activity_at")

  metadata Json @default("{}")

  user    CritUser     @relation(fields: [playerId], references: [id], onDelete: Restrict)
  product CritProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([playerId])
  @@index([status])
  @@index([dropletId])
  @@index([createdAt])
  @@index([startedAt])
  @@index([scheduledEndAt])
  @@map("crit_virtual_desktop_sessions")
}

model CritApiKey {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  playerId String @map("player_id")
  provider String @db.VarChar(50) // 'anthropic', 'openai', 'world_anvil'
  keyName  String @db.VarChar(255)

  apiKeyEncrypted String @map("api_key_encrypted") @db.Text

  isActive       Boolean   @default(true) @map("is_active")
  isVerified     Boolean   @default(false) @map("is_verified")
  lastVerifiedAt DateTime? @map("last_verified_at")
  lastUsedAt     DateTime? @map("last_used_at")
  usageCount     Int       @default(0) @map("usage_count")

  monthlyLimitUsd      Decimal? @map("monthly_limit_usd") @db.Decimal(10, 2)
  currentMonthUsageUsd Decimal  @default(0) @map("current_month_usage_usd") @db.Decimal(10, 2)

  user CritUser @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, provider, keyName])
  @@index([playerId])
  @@index([provider])
  @@index([isActive])
  @@map("crit_api_keys")
}

model CritSession {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Session identification
  sessionType String @map("session_type") @db.VarChar(50) // 'paid_gm', 'free', 'practice'
  status      String @default("scheduled") @db.VarChar(50) // 'scheduled', 'active', 'completed', 'cancelled'

  // Timing
  scheduledStartAt DateTime  @map("scheduled_start_at")
  actualStartAt    DateTime? @map("actual_start_at")
  scheduledEndAt   DateTime  @map("scheduled_end_at")
  actualEndAt      DateTime? @map("actual_end_at")
  durationMinutes  Int?      @map("duration_minutes") // Actual duration

  // Financial (for paid sessions)
  gmHourlyRate   Decimal? @map("gm_hourly_rate") @db.Decimal(10, 2) // Crit-Coins per hour
  totalCritCoins Decimal? @map("total_crit_coins") @db.Decimal(10, 2) // Total coins for session
  platformFee    Decimal? @map("platform_fee") @db.Decimal(10, 2) // Platform's cut (if any)
  gmEarnings     Decimal? @map("gm_earnings") @db.Decimal(10, 2) // GM's earnings in CC

  // Payout tracking
  payoutStatus     String?   @map("payout_status") @db.VarChar(50) // 'pending', 'paid_cash', 'paid_coins', null
  payoutMethod     String?   @map("payout_method") @db.VarChar(50) // 'stripe', 'crit_coins', null
  payoutAmount     Decimal?  @map("payout_amount") @db.Decimal(10, 2) // USD if cash, CC if coins
  payoutDate       DateTime? @map("payout_date")
  stripeTransferId String?   @map("stripe_transfer_id") @db.VarChar(255)

  // Participants
  playerCount Int @default(0) @map("player_count")
  gmCount     Int @default(1) @map("gm_count")

  // Game details
  systemName     String? @map("system_name") @db.VarChar(255) // 'D&D 5e', 'Pathfinder', etc
  campaignName   String? @map("campaign_name") @db.VarChar(255)
  sessionTitle   String? @map("session_title") @db.VarChar(500)
  sessionSummary String? @map("session_summary") @db.Text

  // Metadata
  metadata Json @default("{}")

  // Relations
  // NOTE: sessions relation to RpgSession is in Core Concepts database
  storyCreditTransactions CritStoryCreditTransaction[]

  @@index([sessionType])
  @@index([status])
  @@index([scheduledStartAt])
  @@index([payoutStatus])
  @@map("crit_sessions")
}

// ============================================================================
// RPG World Data Tables (Exportable User Data shared with owning creators and their players or spectators)
// ============================================================================


// RpgHistory (immutable event log with significance tracking)

// Timeline metadata - tracks parallel timelines created by multiverse/time travel

// Alternate timeline events - parallel to rpg_history but for non-prime timelines

// ============================================================================
// Assets - Core Concept (images, audio, video, 3D models, etc.)
// Like other core concepts, Assets have both Rpg and Crit counterparts
// ============================================================================

// CritAsset - Marketplace assets with strict ownership/rights tracking
// Owner has legal rights to publish and monetize the content
model CritAsset {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Asset info
  name        String  @db.VarChar(255)
  description String? @db.Text
  assetType   String  @map("asset_type") @db.VarChar(50)
  // 'image', 'audio', 'video', 'tile', 'token', 'map', 'music', 'sfx', '3d_model', etc.

  // File information
  url      String @db.Text // Vercel Blob URL
  mimeType String @map("mime_type") @db.VarChar(100)
  fileSize BigInt @map("file_size") // bytes
  filename String @db.VarChar(255)

  // Dimensions (for images/video)
  width  Int?
  height Int?

  // Duration (for audio/video in seconds)
  duration Int?

  // Ownership & Rights (STRICT - for marketplace)
  ownerId String   @map("owner_id")
  owner   CritUser @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Marketplace settings
  isPublic      Boolean  @default(false) @map("is_public")
  isMarketplace Boolean  @default(false) @map("is_marketplace") // Available for purchase
  price         Decimal? @db.Decimal(10, 2) // Crit-Coins price

  // Categorization & Discovery
  category String?  @db.VarChar(50)
  tags     String[] @default([])

  // Usage & Analytics
  downloadCount Int @default(0) @map("download_count")
  viewCount     Int @default(0) @map("view_count")

  // File-specific metadata (JSON for flexibility)
  metadata Json @default("{}") @db.JsonB
  // Examples:
  // - Tiles: { tileSize: 60, isTransparent: true, gridType: "square" }
  // - Audio: { bitrate: 320, channels: 2, sampleRate: 44100 }
  // - Images: { format: "png", hasAlpha: true, colorSpace: "sRGB" }

  @@index([ownerId])
  @@index([assetType])
  @@index([category])
  @@index([isPublic])
  @@index([isMarketplace])
  @@map("crit_assets")
}

// RpgAsset - In-game assets (less strict ownership tracking)
// Tracks which player uploaded it and which world it originated from

// ============================================================================
// VTT Tile System (Maps, Boards, Cards)
// ============================================================================

// RpgTile - Template for tiles at different scales
// A tile can have multiple scale versions as RpgAssets

// RpgExpansion (premium content - official expansions/adventures)
// Unlocked via: Physical UPC scan (1 month), D&D Beyond/VTT ownership (permanent)

// RpgExpansionAccess (track player/campaign access to premium expansions)
// Campaign-wide: If ONE player in a campaign owns content, ALL players have access

// RpgSheet (universal container for tracking resources, game state, and entities)
// Can represent locations, creatures, player hands, or any other game entity

// Board (active 50x50x50 play area)

// ============================================================================
// Spatial Objects (Doors, Furniture, Destructible Objects)
// ============================================================================

// Object (pre-defined object templates)
// RpgThing - Things that exist in the game world (items, equipment, furniture, etc)
// Flexible, system-defined types and properties
// Not creatures - everything else that can exist in a location or be carried

// ============================================================================
// NPC Behaviors and Needs
// ============================================================================

// RpgCreature - All creatures including NPCs and Player Characters
// Extended creature/character data with behavior axes and needs tracking
// Integrates with existing Character/Creature systems

// ============================================================================
// Foundry VTT License Pool & Instance Management
// ============================================================================



// Links RPG worlds to Foundry instance runtime
// RPG tables are source of truth, this tracks where world is currently loaded

// ============================================================================
// RPG Core Concepts - Additional Tables
// ============================================================================

// ============================================================================
// DEPRECATED EXPANSION TABLES
// ============================================================================
// The following Crit* expansion tables (CritOrbitalSpace, CritUniverse, CritMultiverse)
// are DEPRECATED in favor of the hierarchical RpgLocation system.
//
// NEW APPROACH: RpgLocation now supports all scales from rooms to universes
// - RpgLocation can contain other RpgLocations (hierarchical)
// - RpgLocation can contain RpgWorlds (via containerLocationId)
// - locationScale field defines the scope (Adventure Location → Universe)
//
// MIGRATION STRATEGY:
// - Keep these tables for backward compatibility
// - New data should use RpgLocation with appropriate locationScale
// - Gradually migrate existing CritOrbitalSpace/Universe data to RpgLocation
// - These tables will be removed in a future version
// ============================================================================

// CritOrbitalSpace - DEPRECATED: Use RpgLocation with locationScale='Orbital Space'
// Container for world(s), moons, satellites, alternate planes/dimensions/timelines
// Most game worlds exist within an orbital space. Everything follows same game system rules.
// Part of hierarchy: CritMultiverse → CritUniverse → CritOrbitalSpace → RpgWorld
model CritOrbitalSpace {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Orbital Space info
  name        String  @db.VarChar(200)
  description String? @db.Text
  systemName  String  @map("system_name") @db.VarChar(100) // Primary TTRPG system for this space

  // OWNERSHIP - Critical for access control
  ownerId String   @map("owner_id")
  owner   CritUser @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Universe link (optional - space can exist independently or within a universe)
  universeId String?       @map("universe_id")
  universe   CritUniverse? @relation(fields: [universeId], references: [id], onDelete: SetNull)

  // Space metadata
  settings Json @default("{}") @db.JsonB
  metadata Json @default("{}") @db.JsonB

  // Relations
  // NOTE: worlds relation to RpgWorld is in Core Concepts database

  @@index([systemName])
  @@index([ownerId])
  @@index([universeId])
  @@index([deletedAt])
  @@map("crit_orbital_spaces")
}

// CritUniverse - DEPRECATED: Use RpgLocation with locationScale='Universe'
// Container for multiple orbital spaces (different systems allowed, related genres)
// Part of hierarchy: CritMultiverse → CritUniverse → CritOrbitalSpace → RpgWorld
model CritUniverse {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Universe info
  name        String  @db.VarChar(200)
  description String? @db.Text
  genre       String? @db.VarChar(100) // 'fantasy', 'sci-fi', 'horror', etc.

  // OWNERSHIP - Critical for access control
  ownerId String   @map("owner_id")
  owner   CritUser @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Multiverse link (optional - universe can exist independently or within a multiverse)
  multiverseId String?         @map("multiverse_id")
  multiverse   CritMultiverse? @relation(fields: [multiverseId], references: [id], onDelete: SetNull)

  // Universe metadata
  settings Json @default("{}") @db.JsonB
  metadata Json @default("{}") @db.JsonB

  // Relations
  orbitalSpaces  CritOrbitalSpace[] // Orbital spaces within this universe
  coreMultiverse CritMultiverse?    @relation("CoreUniverse") // If this is the core universe for a multiverse

  @@index([genre])
  @@index([ownerId])
  @@index([multiverseId])
  @@index([deletedAt])
  @@map("crit_universes")
}

// CritMultiverse - DEPRECATED: Not needed as a table
// The multiverse is simply the conceptual collection of all universes (RpgLocations with locationScale='Universe')
// Contains "Core" universe (story-only, not used as setting) and derivative game universes
// Derivative universes numbered incrementally: "-XIV", "-III", etc.
// NOTE: This table is kept for backward compatibility but should not be used for new data
model CritMultiverse {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Multiverse info
  name        String  @db.VarChar(200)
  description String? @db.Text

  // OWNERSHIP - Critical for access control
  ownerId String   @map("owner_id")
  owner   CritUser @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Core universe designation
  coreUniverseId String?       @unique @map("core_universe_id")
  coreUniverse   CritUniverse? @relation("CoreUniverse", fields: [coreUniverseId], references: [id], onDelete: SetNull)

  // Multiverse metadata
  settings Json @default("{}") @db.JsonB
  metadata Json @default("{}") @db.JsonB

  // Relations
  universes CritUniverse[] // All universes in this multiverse

  @@index([ownerId])
  @@index([deletedAt])
  @@map("crit_multiverses")
}

// RPG World - The actual world/planet (1:1 with FoundryWorldSnapshot)
// Source of truth for campaign worlds. Can extract data from Foundry snapshot
// and update snapshot when "downtime" activities occur while world is offline.

// RpgWorldWiki - World-specific wiki pages
// Each RpgWorld can have its own wiki for documenting lore, NPCs, locations, etc.

// RpgWorldWikiRevision - Revision history for world wiki pages

// RPG Campaign - A series of connected game sessions

// CampaignMember - Players who are members of a campaign

// RpgType - Entity type templates (classes, races, creature types, etc.)

// RpgTable - Random tables, lookup tables, and roll tables

// RpgCard - Game cards (spell cards, item cards, ability cards, etc.)

// RpgDeck - Collections of cards

// RpgRule - Game rules and mechanics

// RpgEvent - Game events log
// Flexible event system that supports location-driven events, combat, chat, etc.

// RpgGoal - Campaign goals and objectives

// RpgMode - Game mode definitions

// RpgSystem - Actual RPG game systems (D&D 5e, Cypher, Pathfinder, etc.)

// ============================================================================
// Creator Marketplace
// ============================================================================

// MarketplaceCommission - Custom content commissions
model CritMarketplaceCommission {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Commission details
  type        String @db.VarChar(50) // 'character_portrait', 'npc_voice', 'quest_text', etc.
  title       String @db.VarChar(200)
  description String @db.Text

  // Payment
  paymentType String    @default("story_credits") @map("payment_type") @db.VarChar(20)
  // 'crit_coins' or 'story_credits'
  budget      Decimal   @db.Decimal(10, 2) // Amount in the specified currency
  deadline    DateTime?

  // Parties
  requestorId String  @map("requestor_id")
  creatorId   String? @map("creator_id")

  // Status
  status String @default("open") @db.VarChar(20)
  // 'open', 'in_progress', 'submitted', 'approved', 'completed', 'cancelled'

  // Escrow (always in Story Credits)
  escrowHeld   Boolean  @default(false) @map("escrow_held")
  escrowAmount Decimal? @map("escrow_amount") @db.Decimal(10, 2) // Story Credits held in escrow
  escrowTxId   String?  @unique @map("escrow_tx_id") // Links to StoryCreditTransaction

  // Payment tracking
  coinTxId       String?  @unique @map("coin_tx_id") // If paid with Crit-Coins
  platformMargin Decimal? @map("platform_margin") @db.Decimal(10, 2) // For Crit-Coins payments (20%)

  // Deliverables
  deliveryFiles Json?     @map("delivery_files") @db.JsonB // Array of file URLs
  deliveredAt   DateTime? @map("delivered_at")
  approvedAt    DateTime? @map("approved_at")

  // Reviews
  requestorRating Int?    @map("requestor_rating") // 1-5
  creatorRating   Int?    @map("creator_rating") // 1-5
  requestorReview String? @map("requestor_review") @db.Text
  creatorReview   String? @map("creator_review") @db.Text

  @@index([requestorId])
  @@index([creatorId])
  @@index([status])
  @@index([type])
  @@index([paymentType])
  @@index([deletedAt])
  @@map("crit_marketplace_commissions")
}

// CommissionProposal - Artist proposals for commissions
model CritCommissionProposal {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  commissionId String @map("commission_id")
  creatorId    String @map("creator_id")

  // Proposal details
  price         Decimal @db.Decimal(10, 2) // Counter-offer price (in commission's currency)
  message       String  @db.Text
  portfolioUrls Json?   @map("portfolio_urls") @db.JsonB
  estimatedDays Int?    @map("estimated_days")

  // Status
  status String @default("pending") @db.VarChar(20)
  // 'pending', 'accepted', 'rejected', 'withdrawn'

  @@index([commissionId])
  @@index([creatorId])
  @@index([status])
  @@index([deletedAt])
  @@map("crit_commission_proposals")
}

// ============================================================================
// Player Characters & Downtime
// ============================================================================

// RpgActivity -  either during or between sessions, "downtime" flag (Player or NPC)

// ============================================================================
// Views (created after migration)

// ============================================================================
// Additional Core Concept Tables
// ============================================================================

// RpgSubSystem - Child systems under RpgSystem

// RpgAttribute - Trackable attributes (HP, XP, Name, etc.)

// RpgLocation - Hierarchical location system supporting all scales from rooms to universes
// Locations can contain other locations AND worlds, enabling flexible scale hierarchies

// Note: Merged into RpgThing model above
// Behavior scripts, loot generation, and system-specific properties
// are stored in the flexible properties JSON field

// RpgBook - Books and compendiums

// RpgVoxel - Volumetric positioning for gridless/narrative movement

// ============================================================================

// CREATE VIEW crit_coin_balances AS
// SELECT
//   player_id,
//   SUM(CASE WHEN transaction_type = 'credit' THEN amount ELSE -amount END) as total_balance,
//   SUM(CASE
//     WHEN transaction_type = 'credit'
//     AND (expires_at IS NULL OR expires_at > NOW())
//     THEN amount
//     WHEN transaction_type = 'debit'
//     THEN -amount
//     ELSE 0
//   END) as available_balance
// FROM crit_coin_transactions
// GROUP BY player_id;
