# Deploy Core Concepts API to Production (DO App Platform)
# Triggered manually or on push to main branch with API changes

name: Deploy API - Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'packages/core-concepts-api/**'
      - '.github/workflows/deploy-api-prod.yml'

env:
  DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

jobs:
  build-and-push:
    name: Build and Push to Container Registry
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DO Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Build and push Docker image
        working-directory: packages/core-concepts-api
        run: |
          docker build -t registry.digitalocean.com/crit-fumble/core-concepts-api:${{ github.sha }} .
          docker build -t registry.digitalocean.com/crit-fumble/core-concepts-api:latest .
          docker push registry.digitalocean.com/crit-fumble/core-concepts-api:${{ github.sha }}
          docker push registry.digitalocean.com/crit-fumble/core-concepts-api:latest

  deploy:
    name: Deploy to App Platform
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to App Platform
        run: |
          # Trigger deployment of existing app
          # The app is configured to use the container registry image
          doctl apps create-deployment ${{ secrets.DO_APP_ID }} --wait

      - name: Run migrations
        run: |
          # Migrations are run as part of the app's run command
          # Or can be triggered via console command
          echo "Migrations will run automatically on startup"

      - name: Verify deployment
        run: |
          # Get the app URL and verify health
          APP_URL=$(doctl apps get ${{ secrets.DO_APP_ID }} --format LiveURL --no-header)
          echo "Checking health at $APP_URL/health"
          sleep 10
          curl -f "$APP_URL/health" || echo "Health check pending..."

      - name: Notify on failure
        if: failure()
        run: echo "Production deployment failed! Check logs."
